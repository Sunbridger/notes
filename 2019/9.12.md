# 内网聊天wechat


- 微信网页版，使用公司网络，公司可以看到聊天内容，无论使用的是公司电脑还是个人电脑。


- 微信网页版，使用4G网络，流量没走公司，公司自然也无法看到聊天内容。

- 微信手机版，使用私有协议通信，手机APP嵌入了服务器的公钥，APP只认与这个公钥一一对应的私钥签名。使用其它私钥签名的一概不认，所以无法欺骗微信APP。使用微信手机版聊天是安全的，无论是使用公司网络还是4G网络，公司都无法看到聊天内容。


## MMTLS是什么样的存在？
MMTLS是TLS1.3版本的改良版，或者说简化版。在微信决定使用MMTLS之前，TLS1.3版本长期逗留在草案状态，没有形成一个最终标准。于是微信决定采用TLS1.3草案中的标准，大刀阔斧砍掉客户端认证这个环节，只保留服务器认证。
 
手机微信APP里预置了微信服务器的两件秘密武器：
 
1. ECDSA公钥
2. 静态ECDH公钥
 
## ECDSA公钥是干嘛的？
ECDSA用于验证服务器的真实身份，任何来自于服务器的MMTLS协商报文，只要使用ECDSA私钥签名的，ECDSA公钥都可以解密。换句话说，如果签名部分可以使用ECDSA公钥解密，那就证明是真正微信服务器发送的！
 
在微信的私有实现里，不需要CA，微信客户端凭借预置的ECDSA公钥完成服务器的认证！
 
## 静态ECDH公钥又是干嘛的？
如果微信客户端想最小延迟（0 RTT）发消息，可以直接生成自己的ECDH私钥、公钥、Nonce，再加上服务器预置的Nonce。就可以单方面计算出Pre-Master Key ，Master Key ， Session Key，进而将消息加密发出。
 
微信服务器收到消息的同时，一同收到的还有客户端的ECDH公钥、客户端Nonce，服务器用自己的ECDH私钥、预留在客户端的Nonce，这四个参数，计算出可以解密消息的Key，并将消息解密出。
 
MMTLS没有给消息增加额外的延迟，称这种通信为 0 RTT通信。
 
由于微信客户端，强制使用服务器的ECDSA公钥来认证服务器的身份，所以Fiddle压根没法欺骗微信APP。如果Fiddle强制替换，微信客户端会放弃连接服务器，造成的后果就是微信永远登录不了服务器！
 
微信APP之所以可以实现私有协议，是因为服务器、客户端都是微信的代码，再怎么私有，理解起来也没有任何障碍！
 