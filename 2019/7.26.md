# PWA的实现
从技术层面来说，pwa应实现以下功能：

- 离线可访问

- 可以从桌面图标进入

- 可以实现用户推送

## 离线缓存 sevice worker
sevice worker是由js编写，运行在应用程序和浏览器之间的代理服务器，给 web 应用提供高级的可持续的后台处理能力。它能够创建有效的离线体验，拦截网络请求并基于网络是否可用以及更新的资源是否驻留在服务器上来采取适当的动作。





# Http2


1. 二进制分帧
> 帧：HTTP/2 数据通信的最小单位消息：指 HTTP/2 中逻辑上的 HTTP 消息。例如请求和响应等，消息由一个或多个帧组成。
> 流：存在于连接中的一个虚拟通道。流可以承载双向消息，每个流都有一个唯一的整数ID。
-  HTTP/2 采用二进制格式传输数据，而非 HTTP 1.x 的文本格式，二进制协议解析起来更高效。 HTTP / 1 的请求和响应报文，都是由起始行，首部和实体正文（可选）组成，各部分之间以文本换行符分隔。HTTP/2 将请求和响应数据分割为更小的帧，并且它们采用二进制编码。

-  HTTP/2 中，同域名下所有通信都在单个连接上完成，该连接可以承载任意数量的双向数据流。每个数据流都以消息的形式发送，而消息又由一个或多个帧组成。多个帧之间可以乱序发送，根据帧首部的流标识可以重新组装。

2. 多路复用
> 其代替原来的序列和阻塞机制，所有就是请求的都是通过一个 TCP连接并发完成。 HTTP 1.x 中，如果想并发多个请求，必须使用多个 TCP 链接，且浏览器为了控制资源，还会对单个域名有 6-8个的TCP链接请求限制。
- 同个域名只需要占用一个 TCP 连接，消除了因多个 TCP 连接而带来的延时和内存消耗。（同域名下所有通信都在单个连接上完成。）
- 单个连接上可以并行交错的请求和响应，之间互不干扰。（单个连接可以承载任意数量的双向数据流。）
- 在HTTP/2中，每个请求都可以带一个31bit的优先值，0表示最高优先级， 数值越大优先级越低。有了这个优先值，客户端和服务器就可以在处理不同的流时采取不同的策略，以最优的方式发送流、消息和帧
- 数据流以消息的形式发送，而消息又由一个或多个帧组成，多个帧之间可以乱序发送，因为根据帧首部的流标识可以重新组装。

3. 头部压缩
HTTP1.x的header中的字段很多时候都是重复的，例如method:get、status:200等等，随着网页增长到需要数十到数百个请求，这些请求中的冗余标头字段不必要地消耗带宽，从而显著增加了延迟
- HTTP/2在客户端和服务器端使用“首部表”来跟踪和存储之前发送的键－值对，对于相同的数据，不再通过每次请求和响应发送；
- 首部表在HTTP/2的连接存续期内始终存在，由客户端和服务器共同渐进地更新;
- 每个新的首部键－值对要么被追加到当前表的末尾，要么替换表中之前的值。
> 请求一发送了所有的头部字段，第二个请求则只需要发送差异数据，这样可以减少冗余数据，降低开销。

`原理讲解`
- 消息发送端和消息接受端共同维护一份静态表和一份动态表（这两个合起来充当字典的角色），
- 每次请求时，发送方根据字典的内容以及一些特定指定，编码压缩消息头部，
- 接收方根据字典进行解码，并且根据指令来判断是否需要更新动态表
首先介绍一下前面在说明“压缩过程”时，提到的字典。在Hpack中，一共使用2个表来充当字典的角色：静态表和动态表。
## 静态表
1. name和value都可以完全确定，比如:metho: GET、:status: 200 [更多点此](https://httpwg.org/specs/rfc7541.html#static.table.definition)
2. 只能够确定name：比如:authority、cookie

- 第一种情况很好理解，已知键值对直接使用一个字符表示；
- 第二种情况稍微说明下：首先将name部分先用一个字符（比如cookie）来表示，同时，根据情况判断是否告知服务端，将 cookie: xxxxxxx 添加到动态表中（我们这里默认假定是从客户端向服务端发送消息）

## 动态表

- 动态表最初是一个空表，当每次解压头部的时候，有可能会添加条目（比如前面提到的cookie，当解压过一次cookie时，`cookie: xxxxxxx`就有可能被添加到动态表了，至于是否添加要根据后面提到的指令判断）
- 动态表允许包含重复的条目，也就是可能出现完全相同的键值对
- 为了限制解码器的需求，动态表大小有严格限制的

## 索引地址空间
静态表和动态表一起组成一个索引地址空间。设静态表长度为s,动态表长度为k，那么最终的索引空间如下：
```
<----------  Index Address Space ---------->
<-- Static  Table -->  <-- Dynamic Table -->
+---+-----------+---+  +---+-----------+---+
| 1 |    ...    | s |  |s+1|    ...    |s+k|
+---+-----------+---+  +---+-----------+---+
                       ^                   |
                       |                   V
                Insertion Point      Dropping Point
```
其中：
- 索引1-s是静态表，s-k是动态表，
- 新的条目从在动态表的开头插入，从动态表末尾移除

有了这个索引空间以后，header的字段一共有以下几种表示方法：

- 直接用索引值来表示（比如2表示method：get）
- 字段的name使用索引值表示，字段的value直接使用原有字面的值的八位字节序列或者使用静态哈夫曼编码表示